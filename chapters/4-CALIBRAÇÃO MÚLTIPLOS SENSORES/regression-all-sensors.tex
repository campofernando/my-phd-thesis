
% ----------------------------------------------------------
\chapter{Metodologia de correção de leituras provenientes de sensores de baixo custo da qualidade do ar}\label{cap:calib-methodology}
% ----------------------------------------------------------

No Capítulo \ref{cap:field-monit-results} foi apresentado o processo de co-localização do dispositivo de baixo custo com a estação de referência e foram comparadas as leituras de cada equipamento. A última etapa do processamento, que será abordada neste capítulo, consistiu em desenvolver uma metodologia para corrigir as medições adquiridas pelo equipamento de baixo custo a partir dos dados de referência da estação certificada. 

\begin{figure}[h!]
    \centering
    \caption{Fluxogramas do processo de correção das leituras do equipamento de baixo custo}
    \begin{subfigure}{0.9\textwidth}
        \includegraphics[width=\textwidth]{chapters/4-CALIBRAÇÃO MÚLTIPLOS SENSORES/Figuras/Processo de calibração unisensor.png}
        \caption{Etapa de correção das leituras de cada sensor}
        \label{fig:calibration-unisensor}
    \end{subfigure}
    \begin{subfigure}{0.9\textwidth}
        \includegraphics[width=\textwidth]{chapters/4-CALIBRAÇÃO MÚLTIPLOS SENSORES/Figuras/Processo de calibração multisensor.png}
        \caption{Etapa de correção das leituras do equipamento considerando todos seus sensores}
        \label{fig:calibration-multisensor}
    \end{subfigure}
\end{figure}

O processo de correção foi realizado em duas etapas, ilustradas nas Figuras \ref{fig:calibration-unisensor} e \ref{fig:calibration-multisensor}. O Anexo \ref{anex:calibration-notebooks} apresenta o código utilizado para aplicar as correções às leituras dos sensores OX-B431. Em um primeiro momento (Figura \ref{fig:calibration-unisensor}), aplicou-se uma busca em \textit{grid} para encontrar o modelo de regressão que melhor corrigisse as leituras dos sensores de cada poluente. Nesta primeira etapa, foram consideradas como entradas ao modelo apenas as leituras dos sensores específicos para cada composto juntamente com os valores de temperatura. No segundo momento (Figura \ref{fig:calibration-multisensor}) aplicou-se também uma busca em \textit{grid} para encontrar um modelo de correção por poluente, mas dessa vez considerando as leituras de todos os sensores de baixo custo no equipamento, além da temperatura. Os dados de entrada nas etapas de correção provieram da etapa de pré-processamento dos dados descrita no Capítulo \ref{cap:field-monit-results}.

\begin{figure}[h!]
    \centering
    \caption{Processo de geração de combinações de variáveis, modelos e seus parâmetros}
    \includegraphics[width=0.5\textwidth]{chapters/4-CALIBRAÇÃO MÚLTIPLOS SENSORES/Figuras/Fluxograma busca em Grid.png}
    \label{fig:grid-search}
\end{figure}

Para a correção das leituras adquiridas pelos sensores foram explorados diferentes modelos de regressão multivariados, i.e.: o Perceptron Multicamadas (MLP), Regressão Linear Multivariada (MLR), K Vizinhos mais Próximos (KNN) e as Florestas Aleatórias (RF). Para encontrar o modelo que melhor explicasse os dados foram realizadas buscas em \textit{grid} que combinaram diferentes parâmetros e variáveis de entrada. Os modelos foram avaliados utilizando validações cruzadas com k = 3 considerando métricas essenciais, i.e.: o coeficiente de determinação (R2), o erro médio quadrático (RMSE) e o erro absoluto médio (MAE). Como a complexidade dos modelos aumenta com o incremento das variáveis independentes, também foram consideradas as métricas de \acrshort{aic} e \acrshort{bic} na avaliação dos modelos de regressão.

A Figura \ref{fig:grid-search} apresenta um fluxograma da metodologia aplicada nas duas etapas de correção. O processo consiste em três laços. O laço mais externo itera ao longo de uma lista com as distintas combinações de variáveis de entrada. Esta lista, dependendo da etapa de correção, pode estar composta pelas leituras de um ou dois sensores de um mesmo poluente com a temperatura, ou por todos os sensores do equipamento e a temperatura. Para gerar as combinações de variáveis foi considerado que cada sensor poderia representar apenas uma entrada, e que cada combinação deveria ter pelo menos um sensor do poluente em questão. Exemplificando, a primeira etapa de correção das leituras de \acrshort{o3} iteraria sobre a lista de combinatórias formada por: 

\begin{lstlisting}[basicstyle=\tiny]
    [[Leituras OX-B431 (1)], 
    [Leituras OX-B431 (2)], 
    [Leituras OX-B431 (1), Leituras OX-B431 (2)],
    [Leituras OX-B431 (1), Leituras de temperatura],
    [Leituras OX-B431 (2), Leituras de temperatura],
    [Leituras OX-B431 (1), Leituras OX-B431 (2), Leituras de temperatura]] 
\end{lstlisting}

Já na segunda etapa de correção das leituras de \acrshort{o3} não poderia ser considerada, por exemplo, a seguinte combinação de variáveis de entrada, já que esta não possui nenhuma leitura de sensor de \acrshort{o3}.

\begin{lstlisting}[basicstyle=\tiny]
    [Leituras CO-B4, Leituras NO2-B43F, Leituras de OPC-N3, Leituras de Temperatura]
\end{lstlisting}

Uma vez gerado o conjunto de combinações de variáveis de entrada, o segundo e terceiro laço iteram por conjuntos de modelos de regressão e de parâmetros desses modelos. Em cada iteração do terceiro laço são selecionados os melhores parâmetros para cada modelo de regressão. Para isso utilizou-se a classe \textit{GridSearchCV} do pacote \textit{sklearn.model\_selection} de \textit{Python}. A Tabela \ref{tab:models-and-parameters} resume os parâmetros que ajustados para cada modelo. Uma vez selecionados os parâmetros, o segundo laço calcula os valores de R2, RMSE, MAE, AIC e BIC produzidos por cada modelo utilizando validações cruzadas com k = 3.

\begin{table}[h!]
    \caption{Parâmetros ajustados para cada modelo nas buscas em \textit{grid}}
    \centering
    \begin{tabularx}{0.95\textwidth}[h!]{
         >{\raggedright\hsize=.2\hsize\arraybackslash}X
         >{\raggedright\hsize=.7\hsize\arraybackslash}X }
        \hline
        \textbf{Modelo} & \textbf{Parâmetros} \\ [0.5ex]
        \hline
        MLP & No. de camadas ocultas \\ [0.5ex]
            & Coeficiente \textit{alpha} \\ [0.5ex]
        \hline
        KNN & No. de vizinhos \\ [0.5ex]
        \hline
        RF & No. de estimadores \\ [0.5ex]
           & Profundidade máxima \\ [0.5ex]
           & No. de amostras para dividir um nó \\ [0.5ex]
           & No. mínimo de amostras por folha \\ [0.5ex]
        \hline
        MLR & --- \\ [0.5ex]
        \hline
    \end{tabularx}
    \label{tab:models-and-parameters}
\end{table}

\input{chapters/4-CALIBRAÇÃO MÚLTIPLOS SENSORES/Seções/co-regression-all-sensors.tex}

\input{chapters/4-CALIBRAÇÃO MÚLTIPLOS SENSORES/Seções/o3-regression-all-sensors.tex}

\input{chapters/4-CALIBRAÇÃO MÚLTIPLOS SENSORES/Seções/no2-regression-all-sensors.tex}

\input{chapters/4-CALIBRAÇÃO MÚLTIPLOS SENSORES/Seções/mp-regression-all-sensors.tex}

\section{Discussão}

Os modelos de regressão obtidos considerando apenas as leituras de sensores específicos para cada poluente tiveram um mal desempenho. Apenas as leituras dos sensores OX-B431 apresentaram coeficientes de determinação acima de 0.2, com máximos de até 0.6 e valores médios de 0.4 aproximadamente. O restante dos sensores produziu valores negativos de R2, indicando que a variância dos dados reais de concentração não pôde ser explicada pelos modelos de regressão encontrados para os dados dos sensores utilizados. Contudo, a relação entre os dados de saída dos modelos e as leituras originais foi maior em comparação com os dados brutos, chegando a coeficientes de Spearman entre 0.47 e 0.61 entre todos os sensores. É importante ressaltar que os modelos que geraram melhores resultados, todos eles consideraram a temperatura e saída do sensor como variáveis independentes. A Tabela \ref{tab:summary-calib-results} resume os melhores resultados obtidos para cada conjunto de sensores.

Resulta interessante destacar a diferença de comportamento entre os dois sensores OX-B431. Mesmo sendo sensores do mesmo modelo e do mesmo lote, eles apresentaram comportamentos muito distintos com relação as leituras de referência e a dependência com a temperatura. Isso corrobora o reportado na literatura com relação ao comportamento dos sensores de baixo custo.

\begin{table}[h!]
    \caption{Resultados dos melhores modelos considerando leituras de sensores por poluentes}
    \centering
    \begin{tabularx}{0.95\textwidth}[h!]{
         >{\raggedright\hsize=.4\hsize\arraybackslash}X
         >{\raggedright\hsize=.2\hsize\arraybackslash}X 
         >{\raggedright\hsize=.4\hsize\arraybackslash}X
         >{\raggedright\hsize=.4\hsize\arraybackslash}X 
         >{\raggedright\hsize=.4\hsize\arraybackslash}X 
         >{\raggedright\hsize=.3\hsize\arraybackslash}X }
        \hline
        Var. & Modelo & R2 & RMSE & MAE & $\rho$\\ [0.5ex]
        \hline
        \acrshort{co} + T & KNN & -0.63 ± 0.47 & -0.07 ± 0.01 & -0.05 & 0.53 \\ [0.5ex]
        \acrshort{o3} (1) + T & MLP & 0.40 ± 0.16 & -11.29 ± 1.55 & -8.71 ± 1.30 & 0.67 \\ [0.5ex]
        \acrshort{no2} + T & RF & -2.66 ± 4.51 & -11.93 ± 3.39 & -9.18 ± 2.03 & 0.63 \\ [0.5ex]
        \acrshort{mp10} + T & MLP & -0.29 ± 0.27 & -10.68 ± 0.96 & -8.33 ± 0.78 & 0.47 \\ [0.5ex]
        \hline
    \end{tabularx}
    \label{tab:summary-calib-results}
\end{table}

Na Tabela \ref{tab:summary-calib-results-all-sensors} resumem-se os resultados dos melhores modelos por poluente ao considerar as leituras de todos os sensores como variáveis de entrada. Observa-se que de modo geral os parâmetros utilizados para medir o desempenho dos modelos melhorou com relação à Tabela \ref{tab:summary-calib-results}. Os valores de R2, embora ainda pequenos, passaram a ser positivos com exceção do \acrshort{co}, que no entanto mostrou valores de R2 máximo de aproximadamente 0.1. As leituras de \acrshort{o3} mantiveram-se no mesmo intervalo de valores de R2, assim como os valores de erro quadrático e erro absoluto para o restante dos poluentes. Os modelos escolhidos apresentaram menores valores de coeficientes de correlação de Spearman devido a que o parâmetro escolhido para a otimização dos modelos foi o coeficiente de determinação R2.

\begin{table}[h!]
    \caption{Resultados dos melhores modelos por poluente considerando as leituras de todos os sensores nos modelos}
    \centering
    \begin{tabularx}{0.95\textwidth}[h!]{
         >{\raggedright\hsize=.4\hsize\arraybackslash}X
         >{\raggedright\hsize=.2\hsize\arraybackslash}X 
         >{\raggedright\hsize=.4\hsize\arraybackslash}X
         >{\raggedright\hsize=.4\hsize\arraybackslash}X 
         >{\raggedright\hsize=.4\hsize\arraybackslash}X 
         >{\raggedright\hsize=.3\hsize\arraybackslash}X }
        \hline
        Poluente & Modelo & R2 & RMSE & MAE & $\rho$\\ [0.5ex]
        \hline
        \acrshort{co} & MLP & -0.21 ± 0.21 & -0.06 ± 0.01 & -0.05 & 0.42 \\ [0.5ex]
        \acrshort{o3} & MLR & 0.37 ± 0.12 & -11.46 ± 1.91 & -8.92 ± 1.51 & 0.77 \\ [0.5ex]
        \acrshort{no2} & MLR & 0.10 ± 0.04 & -8.43 ± 2.41 & -6.51 ± 1.92 & 0.27 \\ [0.5ex]
        \acrshort{mp10} & MLR & 0.07 ± 0.12 & -9.90 ± 1.69 & -7.41 ± 1.49 & 0.34 \\ [0.5ex]
        \hline
    \end{tabularx}
    \label{tab:summary-calib-results-all-sensors}
\end{table}

Ao comparar os resultados obtidos com os compilados por \cite{Kang2022PerformanceReview} observa-se que os resultados obtidos pelo instrumento desenvolvido são inferiores à maioria dos trabalhos reportados com sensores de baixo custo. Por exemplo, entre os resultados reportados para a medição de \acrshort{mp10}, nenhum trabalho apresentou valores de R2 inferiores a 0.2, com um valor de mediana de 0.68 quando considerados apenas os trabalhos que utilizaram sensores Alphasense para medições em ar ambiente.

Se considerados os resultados para \acrshort{co}, observa-se que valores de R2 inferiores a 0.1 representam menos de 10 \% do total de trabalhos realizados em área externa, nenhum deles utilizando sensores Alphasense. A mediana de R2 reportada por Karagulian para medições de \acrshort{co} em ar ambiente é de 0.68. As medições de \acrshort{no2} encontram-se num patamar similar. Menos de 10 \% dos trabalhos com medições realizadas em área externa com sensores Alphasense obtiveram valores de R2 de 0.1, com um valor de mediana de 0.68.

Como era de esperar os melhores resultados obtiveram-se nas medições de \acrshort{o3}, onde o valor de 0.37 de R2 obtido localiza o presente trabalho entre 20 e 25 \% do total de trabalhos em área externa e entre entre 20 e 25 \% do total de trabalhos em área externa com sensores Alphasense. As medianas para esses dois grupos foram de 0.78 e 0.42 respectivamente.

Apesar de que os resultados em comparação com outros trabalhos foram inferiores, ao considerar a evolução das leituras desde os dados brutos até os modelos multivariados considerando todos os sensores percebe-se uma melhoria na qualidade das leituras do instrumento desenvolvido. Assim, a metodologia de calibração proposta apresenta-se como mais uma alternativa para calibração de outros monitores de baixo custo. Essa metodologia, contudo, tem a ressalva de aumentar a complexidade dos modelos de calibração.

Cabe destacar que a temperatura ganhou menor destaque nesses modelos de regressão, já que apenas os modelos de \acrshort{o3} incluíram a temperatura como variável independente. Por outro lado, todos os poluentes a exceção do \acrshort{no2} consideraram as leituras de pelo menos um dos sensores OX-B431. Dada a forte relação desses sensores com a temperatura, é possível que a sua inclusão tenha substituído a relação com a temperatura. A ausência de temperatura no modelo de \acrshort{no2} faz sentido dada a relação mostrada entre as variáveis.